<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Netflix Killed the Videostore</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      :root {
        --bg-color: #111;
        --gb-body: #c0c0c0;
        --gb-bezel: #555566;
        --nes-black: #000000;
        --nes-white: #ffffff;
        --nes-red: #ff0000;
        --nes-blue: #2c3e50;
        --nes-gold: #eebb55;
        --nes-menu-blue: #66ccff;
        --gb-dpad: #111;
        --gb-btn-a: #9f204b;
        --gb-btn-select: #666;
      }

      body {
        background-color: var(--bg-color);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
        color: var(--nes-white);
        font-family: "Press Start 2P", cursive;
        overflow: hidden;
        touch-action: none;
      }

      /* --- DESKTOP LAYOUT --- */
      #gameboy-body {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      #screen-bezel {
        display: contents;
      }

      .bezel-text,
      .power-led,
      .bezel-top-text,
      .brand-text {
        display: none;
      }

      #display-area {
        position: relative;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        height: 80vh;
        aspect-ratio: 4/3;
        max-width: 95vw;
        background: #000;
        border: 4px solid #333;
        display: flex;
        flex-direction: column;
      }

      /* FEVER MODE EFFECT */
      #display-area.fever {
        border-color: #ff00ff;
        box-shadow: 0 0 30px #ff00ff;
        animation: borderPulse 0.5s infinite alternate;
      }

      @keyframes borderPulse {
        from {
          border-color: #ff00ff;
          box-shadow: 0 0 20px #ff00ff;
        }
        to {
          border-color: #00ffff;
          box-shadow: 0 0 40px #00ffff;
        }
      }

      #ui-layer {
        position: absolute;
        top: 10px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        z-index: 20;
        text-shadow: 2px 2px #000;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      #ui-layer.visible {
        opacity: 1;
      }

      #game-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      canvas {
        display: block;
        image-rendering: pixelated;
        width: 100%;
        height: 100%;
      }

      .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.1) 50%,
          rgba(0, 0, 0, 0.1)
        );
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 10;
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
      }

      #controls {
        display: none;
      }

      /* --- MOBIL / GAME BOY LAYOUT --- */
      @media (max-width: 1024px) and (orientation: portrait) {
        body {
          background-color: #222;
          padding: 10px;
          box-sizing: border-box;
        }

        #gameboy-body {
          display: flex;
          flex-direction: column;
          width: 100%;
          max-width: 400px;
          height: 95vh;
          background-color: var(--gb-body);
          border-radius: 10px 10px 40px 10px;
          box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.5),
            inset 2px 2px 5px rgba(255, 255, 255, 0.4);
          padding: 20px;
          box-sizing: border-box;
          justify-content: flex-start;
          gap: 20px;
          position: relative;
        }

        #screen-bezel {
          display: flex;
          flex-direction: column;
          width: 100%;
          background-color: var(--gb-bezel);
          border-radius: 10px 10px 30px 10px;
          padding: 30px 20px 10px 20px;
          box-sizing: border-box;
          box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
          position: relative;
          flex-shrink: 0;
        }

        .bezel-top-text {
          display: block;
          position: absolute;
          top: 8px;
          left: 5%;
          width: 90%;
          text-align: center;
          color: #888;
          font-size: 10px;
          font-family: sans-serif;
          font-weight: bold;
          border-top: 2px solid #666;
          border-bottom: 2px solid #666;
          height: 12px;
          line-height: 12px;
        }

        .power-led {
          display: block;
          position: absolute;
          top: 40%;
          left: 10px;
          width: 8px;
          height: 8px;
          background-color: #f00;
          border-radius: 50%;
          box-shadow: 0 0 5px #f00;
        }
        .power-led::before {
          content: "BATTERY";
          position: absolute;
          left: 12px;
          top: -2px;
          font-family: sans-serif;
          font-size: 8px;
          color: #ccc;
        }

        #display-area {
          width: 100%;
          height: auto;
          aspect-ratio: 4/3;
          border: 2px solid #444;
          background: #000;
          margin: 0;
          box-shadow: none;
          flex-direction: column;
        }

        #ui-layer {
          position: relative;
          top: auto;
          left: auto;
          width: 100%;
          background: #000;
          padding: 5px;
          font-size: 10px;
          border-bottom: 1px solid #333;
          pointer-events: auto;
          display: flex;
        }

        #ui-layer.hidden {
          visibility: hidden;
          opacity: 0;
        }

        #game-container {
          width: 100%;
          aspect-ratio: 4/3;
          height: auto;
        }

        .bezel-text {
          display: block;
          color: #b0b0c0;
          font-family: sans-serif;
          font-size: 12px;
          text-align: center;
          margin-top: 5px;
          font-style: italic;
          font-weight: bold;
        }

        #controls {
          display: flex;
          width: 100%;
          flex-grow: 1;
          flex-direction: column;
          padding: 10px 0;
          position: relative;
          justify-content: flex-start;
          gap: 20px;
        }

        .upper-controls {
          display: flex;
          width: 100%;
          justify-content: space-between;
          align-items: center;
          padding: 0 10px;
          order: 2;
          margin-top: auto;
          margin-bottom: 20px;
        }

        .brand-text {
          display: block;
          position: absolute;
          bottom: 10px;
          left: 20px;
          font-family: sans-serif;
          font-weight: 900;
          font-style: italic;
          color: #3333aa;
          font-size: 14px;
          opacity: 0.8;
          z-index: 5;
        }

        /* D-Pad */
        .d-pad-container {
          position: relative;
          width: 100px;
          height: 100px;
        }
        .d-pad-horizontal {
          background-color: var(--gb-dpad);
          position: absolute;
          border-radius: 3px;
          width: 90px;
          height: 30px;
          top: 35px;
          left: 5px;
          box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
        }
        .d-pad-vertical {
          background-color: var(--gb-dpad);
          position: absolute;
          border-radius: 3px;
          width: 30px;
          height: 90px;
          left: 35px;
          top: 5px;
          box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
        }
        .d-pad-center {
          position: absolute;
          top: 35px;
          left: 35px;
          width: 30px;
          height: 30px;
          background: radial-gradient(circle, #222 10%, #111 80%);
          z-index: 2;
        }
        .touch-zone {
          position: absolute;
          z-index: 10;
        }
        .zone-up {
          top: 0;
          left: 35px;
          width: 30px;
          height: 40px;
        }
        .zone-down {
          bottom: 0;
          left: 35px;
          width: 30px;
          height: 40px;
        }
        .zone-left {
          top: 35px;
          left: 0;
          width: 40px;
          height: 30px;
        }
        .zone-right {
          top: 35px;
          right: 0;
          width: 40px;
          height: 30px;
        }

        /* A/B Buttons */
        .action-container {
          display: flex;
          gap: 15px;
          transform: rotate(-15deg);
          margin-top: 15px;
          margin-right: 10px;
        }
        .round-btn {
          width: 45px;
          height: 45px;
          background-color: var(--gb-btn-a);
          border-radius: 50%;
          box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
          position: relative;
          display: flex;
          justify-content: center;
          align-items: center;
          color: transparent;
        }
        .round-btn:active {
          transform: scale(0.95);
          box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.4);
        }
        .btn-b {
          margin-top: 20px;
        }
        .label {
          position: absolute;
          bottom: -20px;
          right: -5px;
          color: #333355;
          font-family: sans-serif;
          font-weight: bold;
          font-size: 14px;
          pointer-events: none;
        }

        /* Start/Select */
        .lower-controls {
          display: flex;
          width: 100%;
          justify-content: center;
          gap: 30px;
          order: 1;
          margin-top: 10px;
          margin-bottom: auto;
        }
        .capsule-btn-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
          transform: rotate(-15deg);
        }
        .capsule-btn {
          width: 60px;
          height: 18px;
          background-color: var(--gb-btn-select);
          border-radius: 10px;
          box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
          margin-bottom: 5px;
        }
        .capsule-btn:active {
          transform: scale(0.95);
          box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        .capsule-label {
          color: #333355;
          font-family: sans-serif;
          font-weight: bold;
          font-size: 10px;
          letter-spacing: 1px;
        }

        /* Startskärm Mobile */
        h1 {
          font-size: 4vmin !important;
          line-height: 1.3 !important;
          margin-bottom: 2vh !important;
          width: 100% !important;
          text-align: center !important;
        }
        .menu-item {
          font-size: 3vmin !important;
          padding: 4px !important;
          margin-bottom: 0.5vh !important;
        }
        #start-top-score {
          font-size: 2.5vmin !important;
          margin-top: 2vh !important;
          margin-bottom: 1vh !important;
          width: 100%;
          text-align: center;
        }
        .credits {
          position: static !important;
          font-size: 1.8vmin !important;
          margin-top: 3vh !important;
          color: #ccc;
        }
        .copyright {
          position: static !important;
          font-size: 1.8vmin !important;
          margin-top: 0.5vh !important;
        }
        .cursor-icon {
          width: 2vmin !important;
          height: 1.2vmin !important;
          margin-right: 4px !important;
        }
        #start-screen {
          justify-content: center !important;
          align-items: center !important;
          padding-top: 0 !important;
        }

        #game-over-screen h1 {
          font-size: 5vmin !important;
          margin-bottom: 2vh !important;
        }
        #game-over-screen p {
          font-size: 3vmin !important;
        }
      }

      /* --- LANDSCAPE MOBILE --- */
      @media (max-width: 1024px) and (orientation: landscape) {
        #gameboy-body {
          display: contents;
        }
        #screen-bezel {
          display: contents;
        }
        .bezel-text,
        .power-led,
        .bezel-top-text,
        .brand-text {
          display: none;
        }
        #display-area {
          height: 90vh;
          aspect-ratio: 4/3;
          width: auto;
          max-width: none;
          border: none;
        }
        #controls {
          display: flex;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          justify-content: space-between;
          align-items: flex-end;
          padding: 20px 5vw;
        }
        .d-pad,
        .btn-action {
          display: none;
        } /* Hide GB specific */
        .simple-controls {
          display: flex;
          width: 100%;
          justify-content: space-between;
          pointer-events: auto;
        }
        .btn-simple {
          width: 60px;
          height: 60px;
          background: rgba(255, 255, 255, 0.2);
          border: 2px solid #fff;
          border-radius: 50%;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: auto;
          margin-bottom: 10px;
        }
        .btn-action-simple {
          width: 80px;
          height: 80px;
          background: rgba(255, 0, 0, 0.5);
          border: 2px solid #fff;
          border-radius: 50%;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: center;
          pointer-events: auto;
        }
      }

      /* Global UI text styles */
      #start-top-score {
        color: #ffffff;
        font-size: 2.2vh;
        margin-top: 5vh;
        margin-bottom: 2vh;
        text-shadow: 2px 2px #000;
        text-transform: uppercase;
      }
      h1 {
        color: #eebb55;
        font-size: 3.5vh;
        line-height: 1.4;
        margin-bottom: 4vh;
        text-shadow: 4px 4px 0px #8b4513, 6px 6px 0px #000;
        text-transform: uppercase;
      }
      .title-netflix {
        color: #e50914 !important;
        text-shadow: 3px 3px 0px #500000, 5px 5px 0px #000 !important;
      }
      .title-blockbuster {
        color: #eebb55 !important;
        text-shadow: 3px 3px 0px #003399, 5px 5px 0px #000 !important;
      }
      #menu-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 20px;
      }
      .menu-item {
        font-size: 2.2vh;
        color: var(--nes-menu-blue);
        margin-bottom: 2vh;
        padding: 10px;
        cursor: pointer;
        text-shadow: 2px 2px #000;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
        text-decoration: none;
        user-select: none;
      }
      .menu-item.selected {
        color: #ffffff;
      }
      .credits {
        position: absolute;
        bottom: 35px;
        width: 100%;
        text-align: center;
        color: #ccc;
        font-size: 10px;
        text-shadow: 2px 2px #000;
      }
      .copyright {
        position: absolute;
        bottom: 15px;
        width: 100%;
        text-align: center;
        color: var(--nes-gold);
        font-size: 10px;
        text-shadow: 2px 2px #000;
      }
      .cursor-icon {
        width: 20px;
        height: 12px;
        display: inline-block;
        position: relative;
        margin-right: 10px;
        visibility: hidden;
        background: #333;
        border: 1px solid #fff;
      }
      .menu-item.selected .cursor-icon {
        visibility: visible;
      }
      .cursor-icon::after,
      .cursor-icon::before {
        content: "";
        position: absolute;
        background: #fff;
        width: 4px;
        height: 4px;
        border-radius: 50%;
      }
      .cursor-icon::after {
        top: 2px;
        left: 2px;
      }
      .cursor-icon::before {
        top: 2px;
        right: 2px;
      }
      .blink {
        animation: blinker 1s linear infinite;
        color: #f1c40f;
        cursor: pointer;
        font-size: 2.5vh;
        margin-top: 20px;
        padding: 20px;
      }
      @keyframes blinker {
        50% {
          opacity: 0;
        }
      }
      #high-score-display {
        color: #f1c40f;
        text-shadow: 1px 1px 0 #000;
      }
      #level-display {
        color: #fff;
        text-shadow: 1px 1px 0 #000;
      }
      /* Rank text på Game Over */
      #rank-display {
        color: #eebb55;
        font-size: 1.5vh;
        margin-top: 10px;
        text-transform: uppercase;
        text-shadow: 1px 1px 0 #000;
      }

      #start-screen,
      #game-over-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
      }

      /* SHAKE EFFECT */
      .shake {
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }

      @keyframes shake {
        10%,
        90% {
          transform: translate3d(-4px, 0, 0);
        }
        20%,
        80% {
          transform: translate3d(6px, 0, 0);
        }
        30%,
        50%,
        70% {
          transform: translate3d(-8px, 0, 0);
        }
        40%,
        60% {
          transform: translate3d(8px, 0, 0);
        }
      }
    </style>
  </head>
  <body>
    <div id="gameboy-body">
      <div id="screen-bezel">
        <div class="bezel-top-text">DOT MATRIX WITH STEREO SOUND</div>
        <div class="power-led"></div>

        <!-- Här appliceras shake-effekten på hela skärmen -->
        <div id="display-area">
          <div id="ui-layer" class="hidden">
            <div id="score-display">POÄNG: 0</div>
            <div id="level-display">NIVÅ: 1</div>
            <div id="high-score-display">HI: 0</div>
            <div id="lives-display">LIV: VHS VHS VHS</div>
          </div>

          <div id="game-container">
            <canvas id="gameCanvas" width="640" height="480"></canvas>
            <div class="scanlines"></div>

            <div id="start-screen">
              <h1>
                <span class="title-netflix">NETFLIX KILLED</span><br />
                <span class="title-blockbuster">THE VIDEOSTORE</span>
              </h1>

              <div id="menu-container">
                <div
                  class="menu-item selected"
                  onclick="window.startGame('normal')"
                  ontouchstart="window.startGame('normal'); return false;"
                  onmouseenter="window.selectMenu(this)"
                >
                  <div class="cursor-icon"></div>
                  GAME A (NORMAL)
                </div>
                <div
                  class="menu-item"
                  onclick="window.startGame('hard')"
                  ontouchstart="window.startGame('hard'); return false;"
                  onmouseenter="window.selectMenu(this)"
                >
                  <div class="cursor-icon"></div>
                  GAME B (HARD)
                </div>
              </div>

              <div id="start-top-score">TOP SCORE - 0</div>

              <div class="copyright">&copy;1984 VIDEOSTORE</div>
            </div>

            <div id="game-over-screen" style="display: none">
              <h1 style="color: #888">BUTIKEN STÄNGD</h1>
              <p id="final-score">SLUTPOÄNG: 0</p>
              <div id="rank-display">RANK: PRAKTIKANT</div>
              <p style="color: #e74c3c">STREAMING TOG ÖVER...</p>
              <div
                class="blink"
                onclick="window.goToTitle()"
                ontouchstart="window.goToTitle(); return false;"
              >
                TILL TITELSKÄRM
              </div>
            </div>
          </div>
        </div>

        <div class="bezel-text">NETFLIX KILLED THE VIDEOSTORE</div>
      </div>

      <div class="brand-text">Nintendo GAME BOYTM</div>

      <div id="controls">
        <!-- START / SELECT (Nu överst i layouten tack vare CSS order) -->
        <div class="lower-controls">
          <div class="capsule-btn-wrapper">
            <div
              class="capsule-btn"
              ontouchstart="window.handleSelectButton(); return false;"
            ></div>
            <div class="capsule-label">SELECT</div>
          </div>
          <div class="capsule-btn-wrapper">
            <div
              class="capsule-btn"
              ontouchstart="window.handleStartButton(); return false;"
            ></div>
            <div class="capsule-label">START</div>
          </div>
        </div>

        <div class="upper-controls">
          <!-- D-PAD -->
          <div class="d-pad-container">
            <div class="d-pad-horizontal"></div>
            <div class="d-pad-vertical"></div>
            <div class="d-pad-center"></div>
            <div
              class="touch-zone zone-up"
              ontouchstart="window.movePlayer(-1); return false;"
            ></div>
            <div
              class="touch-zone zone-down"
              ontouchstart="window.movePlayer(1); return false;"
            ></div>
          </div>

          <!-- A/B BUTTONS -->
          <div class="action-container">
            <div
              class="round-btn btn-b"
              ontouchstart="window.throwTape(); return false;"
            >
              <div class="label">B</div>
            </div>
            <div
              class="round-btn btn-a"
              ontouchstart="window.throwTape(); return false;"
            >
              <div class="label">A</div>
            </div>
          </div>
        </div>

        <!-- Landscape Controls fallback -->
        <div class="simple-controls" style="display: none">
          <div class="d-pad-simple">
            <div
              class="btn-simple"
              ontouchstart="window.movePlayer(-1); return false;"
            >
              UPP
            </div>
            <div
              class="btn-simple"
              ontouchstart="window.movePlayer(1); return false;"
            >
              NER
            </div>
          </div>
          <div
            class="btn-action-simple"
            ontouchstart="window.throwTape(); return false;"
          >
            VHS
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. DEFINIERA GLOBALA VARIABLER FÖRST
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const scoreEl = document.getElementById("score-display");
      const levelEl = document.getElementById("level-display");
      const livesEl = document.getElementById("lives-display");
      const highScoreEl = document.getElementById("high-score-display");
      const startTopScoreEl = document.getElementById("start-top-score");
      const startScreen = document.getElementById("start-screen");
      const gameOverScreen = document.getElementById("game-over-screen");
      const finalScoreEl = document.getElementById("final-score");
      const rankDisplayEl = document.getElementById("rank-display");
      const gameContainer = document.getElementById("game-container");
      const displayArea = document.getElementById("display-area");
      const uiLayer = document.getElementById("ui-layer");

      const LANES = 4;
      const LANE_HEIGHT = 85;
      const LANE_START_Y = 130;
      const PLAYER_X = 550;
      const TAP_X = 510;

      let gameLoopId;
      let frameCount = 0;
      let score = 0;
      let level = 1;
      let highScore = localStorage.getItem("vhs_highscore") || 0;
      let lives = 3;

      let isGameRunning = false;
      let isGameOver = false;

      let gameSpeed = 1;
      let difficultyMultiplier = 1;
      let baseDifficulty = 1;
      let gameOverTimeout;

      let isLevelTransition = false;
      let transitionTimer = 0;
      const LEVEL_THRESHOLDS = [1000, 3000];

      let isAttractMode = false;
      let attractTimer;
      let aiCooldown = 0;

      let comboCount = 0;
      let lastHitTime = 0;
      let feverMode = false; // NEW FEVER VAR
      let currentMenuSelection = "normal";

      // Ranks
      const RANKS = [
        { score: 0, title: "PRAKTIKANT" },
        { score: 500, title: "BUTIKSBITRÄDE" },
        { score: 1500, title: "SKIFTLEDARE" },
        { score: 3000, title: "BUTIKSCHEF" },
        { score: 5000, title: "REGIONALCHEF" },
        { score: 10000, title: "VD FÖR BLOCKBUSTER" },
      ];

      // Power-up Variabler
      let powerups = [];
      let rapidFireTimer = 0;

      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioContext();

      let player = {
        lane: 1,
        visualLane: 1,
        cooldown: 0,
        throwAnim: 0,
        isMoving: false,
      };

      let customers = [];
      let tapes = [];
      let particles = [];
      let scoreFloaters = [];

      // Initialisera Text
      highScoreEl.innerText = "HI: " + highScore;
      startTopScoreEl.innerText = "TOP SCORE - " + highScore;

      // 2. DEFINIERA FUNKTIONERNA TYDLIGT
      function toggleUI(show) {
        if (show) {
          uiLayer.classList.remove("hidden");
          uiLayer.classList.add("visible");
        } else {
          uiLayer.classList.remove("visible");
          uiLayer.classList.add("hidden");
        }
      }

      function resetGameVars() {
        score = 0;
        lives = 3;
        level = 1;
        comboCount = 0;
        feverMode = false;
        displayArea.classList.remove("fever"); // Reset fever visual
        isGameOver = false;
        isLevelTransition = false;
        customers = [];
        tapes = [];
        powerups = []; // Reset powerups
        player.lane = 1;
        player.visualLane = 1;
        player.isMoving = false;
        frameCount = 0;
        scoreFloaters = [];
        aiCooldown = 0;
        rapidFireTimer = 0; // Reset Rapid Fire
        if (!isAttractMode && audioCtx.state === "suspended") audioCtx.resume();
      }

      function selectMenu(element) {
        document
          .querySelectorAll(".menu-item")
          .forEach((el) => el.classList.remove("selected"));
        element.classList.add("selected");
        if (element.innerText.includes("HARD")) currentMenuSelection = "hard";
        else currentMenuSelection = "normal";
      }

      function handleStartButton() {
        if (startScreen.style.display !== "none" || isAttractMode) {
          startGame(currentMenuSelection);
        } else if (isGameOver) {
          goToTitle();
        }
      }

      function handleSelectButton() {
        if (isAttractMode) {
          interruptAttractMode();
          return;
        }

        if (startScreen.style.display !== "none") {
          const menuItems = document.querySelectorAll(".menu-item");
          if (currentMenuSelection === "normal") {
            selectMenu(menuItems[1]); // Switch to B
          } else {
            selectMenu(menuItems[0]); // Switch to A
          }
        }
      }

      function startAttractMode() {
        isAttractMode = true;
        isGameRunning = true;
        startScreen.style.display = "none";
        toggleUI(true);
        resetGameVars();
        gameLoop();
      }

      function startAttractTimer() {
        if (attractTimer) clearTimeout(attractTimer);
        attractTimer = setTimeout(startAttractMode, 5000);
      }

      function interruptAttractMode() {
        if (isAttractMode) {
          isAttractMode = false;
          isGameRunning = false;
          cancelAnimationFrame(gameLoopId);
          goToTitle();
        }
      }

      function startGame(mode) {
        if (isAttractMode) interruptAttractMode();
        if (attractTimer) clearTimeout(attractTimer);

        startScreen.style.display = "none";
        toggleUI(true);
        if (gameOverTimeout) clearTimeout(gameOverTimeout);
        baseDifficulty = mode === "hard" ? 1.5 : 1.0;

        resetGameVars();
        isGameRunning = true;
        gameLoop();
      }

      function goToTitle() {
        if (gameOverTimeout) clearTimeout(gameOverTimeout);
        gameOverScreen.style.display = "none";
        startScreen.style.display = "flex";
        toggleUI(false);
        isGameRunning = false;
        startTopScoreEl.innerText = "TOP SCORE - " + highScore;
        displayArea.classList.remove("fever"); // Clear fever
        startAttractTimer();
        draw(); // Rita en frame så vi ser titeln
      }

      function movePlayer(dir) {
        if (isAttractMode) {
          interruptAttractMode();
          return;
        }
        if (isGameOver || isLevelTransition) return;
        player.lane += dir;
        if (player.lane < 0) player.lane = 0;
        if (player.lane >= LANES) player.lane = LANES - 1;
      }

      function throwTape() {
        if (isAttractMode && !isGameOver) {
          player.cooldown = 15;
          player.throwAnim = 10;
          playSound("throw");
          tapes.push({ lane: player.lane, x: PLAYER_X - 10, dead: false });
          return;
        }
        if (isAttractMode) {
          interruptAttractMode();
          return;
        }
        if (
          isGameOver ||
          isLevelTransition ||
          player.isMoving ||
          player.cooldown > 0
        )
          return;

        // RAPID FIRE LOGIC
        const coolDownTime = rapidFireTimer > 0 ? 5 : 15;
        player.cooldown = coolDownTime;

        player.throwAnim = 10;
        playSound("throw");
        tapes.push({ lane: player.lane, x: PLAYER_X - 10, dead: false });
      }

      // POWER UP FUNCTIONS
      function spawnPowerup() {
        const lane = Math.floor(Math.random() * LANES);
        // Random type: 70% Rewind, 30% Rapid Fire
        const type = Math.random() < 0.7 ? "rewind" : "rapid";

        powerups.push({
          lane: lane,
          x: 20, // Start from left
          type: type,
          dead: false,
        });
      }

      function activateRewind() {
        playSound("levelup"); // Use nice sound
        shakeScreen();
        spawnScore(320, 240, "REWIND!");

        customers.forEach((c) => {
          c.pushedBack = c.x + 100; // Push back significantly
        });
      }

      function activateRapidFire() {
        playSound("levelup");
        spawnScore(320, 240, "TURBO MODE!");
        rapidFireTimer = 300; // 5 seconds at 60fps
      }

      function calculateRank(finalScore) {
        let rankTitle = RANKS[0].title;
        for (let r of RANKS) {
          if (finalScore >= r.score) {
            rankTitle = r.title;
          }
        }
        return rankTitle;
      }

      function drawSprite(ctx, type, x, y, options = {}) {
        const p = 4;
        if (type === "player") {
          ctx.fillStyle = "rgba(0,0,0,0.5)";
          ctx.beginPath();
          ctx.ellipse(x + p * 4, y + p * 3, p * 6, p * 2, 0, 0, Math.PI * 2);
          ctx.fill();
          const isMoving = options.isMoving;
          const runAnim = Math.floor(Date.now() / 100) % 2;
          ctx.fillStyle = "#000";
          if (isMoving && runAnim === 0) {
            ctx.fillRect(x + p, y - p, p * 2, p * 4);
            ctx.fillRect(x + p * 5, y, p * 2, p * 3);
          } else if (isMoving && runAnim === 1) {
            ctx.fillRect(x + p, y, p * 2, p * 3);
            ctx.fillRect(x + p * 5, y - p, p * 2, p * 4);
          } else {
            ctx.fillRect(x + p, y, p * 2, p * 3);
            ctx.fillRect(x + p * 5, y, p * 2, p * 3);
          }
          ctx.fillStyle = "#fff";
          ctx.fillRect(x, y - p * 6, p * 8, p * 6);
          ctx.fillStyle = "#3498db";
          ctx.fillRect(x, y - p * 6, p * 2, p * 6);
          ctx.fillRect(x + p * 6, y - p * 6, p * 2, p * 6);
          ctx.fillStyle = "#ffccaa";
          ctx.fillRect(x + p, y - p * 10, p * 6, p * 4);
          ctx.fillStyle = "#e74c3c";
          ctx.fillRect(x + p, y - p * 11, p * 6, p * 1);
          ctx.fillRect(x + p * 6, y - p * 10, p * 2, p * 2);
          ctx.fillStyle = "#ffccaa";
          if (options.throwing > 0) {
            ctx.fillRect(x - p * 4, y - p * 5, p * 5, p * 2);
          } else {
            ctx.fillRect(x + p * 2, y - p * 2, p * 4, p * 4);
          }
        } else if (type === "customer") {
          const color = options.color || "#e74c3c";
          const frame = Math.floor(Date.now() / 200) % 2;
          ctx.fillStyle = "#111";
          if (frame === 0) {
            ctx.fillRect(x + p, y, p * 2, p * 3);
            ctx.fillRect(x + p * 5, y, p * 2, p * 3);
          } else {
            ctx.fillRect(x, y, p * 2, p * 3);
            ctx.fillRect(x + p * 4, y, p * 2, p * 3);
          }
          ctx.fillStyle = color;
          ctx.fillRect(x, y - p * 6, p * 8, p * 6);
          ctx.fillStyle = "rgba(0,0,0,0.2)";
          ctx.fillRect(x, y - p * 4, p * 8, p * 1);
          ctx.fillStyle = "#ffeebb";
          ctx.fillRect(x + p, y - p * 10, p * 6, p * 4);
          ctx.fillStyle = "#555";
          if (color === "#f1c40f") ctx.fillStyle = "#e67e22";
          if (color === "#2ecc71") ctx.fillStyle = "#000";
          ctx.fillRect(x + p, y - p * 11, p * 6, p * 2);
          ctx.fillRect(x + p, y - p * 10, p * 1, p * 3);
          ctx.fillStyle = "#000";
          ctx.fillRect(x + p * 2, y - p * 8, p * 4, p * 1);
        } else if (type === "powerup") {
          const isRewind = options.subType === "rewind";
          // Simple visual representation
          ctx.fillStyle = isRewind ? "#3498db" : "#e74c3c"; // Blue or Red

          // Draw boxy shape
          ctx.fillRect(x, y - 20, 20, 20);

          // Icon inside
          ctx.fillStyle = "#fff";
          if (isRewind) {
            // Draw <<
            ctx.beginPath();
            ctx.moveTo(x + 15, y - 18);
            ctx.lineTo(x + 5, y - 10);
            ctx.lineTo(x + 15, y - 2);
            ctx.fill();
            // Double arrow look
            ctx.beginPath();
            ctx.moveTo(x + 10, y - 18);
            ctx.lineTo(x + 0, y - 10);
            ctx.lineTo(x + 10, y - 2);
            ctx.fill();
          } else {
            // Draw Lightning/Can shape
            ctx.fillRect(x + 5, y - 15, 10, 10);
          }

          // Glow
          ctx.strokeStyle = "#fff";
          ctx.lineWidth = 1;
          ctx.strokeRect(x - 1, y - 21, 22, 22);
        } else if (type === "tape") {
          if (level === 1) {
            // --- VHS KASSETT (NIVÅ 1) ---
            ctx.fillStyle = "#111";
            ctx.fillRect(x, y - 20, 24, 14);
            ctx.fillStyle = "#ddd";
            ctx.fillRect(x + 2, y - 18, 14, 10);
            ctx.fillStyle = "#fff";
            ctx.fillRect(x + 4, y - 16, 4, 4);
            ctx.fillRect(x + 10, y - 16, 4, 4);
          } else if (level === 2) {
            // --- DVD SKIVA (NIVÅ 2) ---
            const centerX = x + 12;
            const centerY = y - 13;

            // DVD Silver Gradient
            const grad = ctx.createLinearGradient(x, y - 26, x + 24, y);
            grad.addColorStop(0, "#ccc");
            grad.addColorStop(0.5, "#fff");
            grad.addColorStop(1, "#999");
            ctx.fillStyle = grad;

            // Skiva
            ctx.beginPath();
            ctx.arc(centerX, centerY, 11, 0, Math.PI * 2);
            ctx.fill();

            // Etikett runt hålet (Cyan för lvl 2)
            ctx.fillStyle = "rgba(0, 255, 255, 0.5)";
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
            ctx.fill();

            // Hålet i mitten
            ctx.fillStyle = "#222";
            ctx.beginPath();
            ctx.arc(centerX, centerY, 2, 0, Math.PI * 2);
            ctx.fill();
          } else {
            // --- BLU-RAY SKIVA (NIVÅ 3) ---
            const centerX = x + 12;
            const centerY = y - 13;

            // Blu-ray Blue Gradient
            const grad = ctx.createLinearGradient(x, y - 26, x + 24, y);
            grad.addColorStop(0, "#00a");
            grad.addColorStop(0.5, "#44f");
            grad.addColorStop(1, "#008");
            ctx.fillStyle = grad;

            // Skiva
            ctx.beginPath();
            ctx.arc(centerX, centerY, 11, 0, Math.PI * 2);
            ctx.fill();

            // Etikett runt hålet (Mörkare blå)
            ctx.fillStyle = "rgba(0, 0, 100, 0.5)";
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
            ctx.fill();

            // Hålet i mitten
            ctx.fillStyle = "#222";
            ctx.beginPath();
            ctx.arc(centerX, centerY, 2, 0, Math.PI * 2);
            ctx.fill();
          }
        } else if (type === "shelf") {
          const bookWidth = 6;
          const bookGap = 2;
          for (let i = 0; i < 640; i += bookWidth + bookGap) {
            const seed = (x + i + y) * 123;
            const r = Math.floor((Math.sin(seed) + 1) * 128);
            const g = Math.floor((Math.cos(seed) + 1) * 128);
            const b = Math.floor((Math.sin(seed * 2) + 1) * 128);
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillRect(x + i, y - 20, bookWidth, 20);
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.fillRect(x + i + bookWidth - 1, y - 20, 1, 20);
          }
        }
      }

      function drawBrickWall(ctx) {
        let bgColor = "#2c0e0e";
        let brickColor = "#3e1a1a";

        if (level === 2) {
          bgColor = "#050510"; // Mörkare blå/svart för nivå 2
          brickColor = "#151530"; // Blåaktiga tegelstenar
        } else if (level >= 3) {
          bgColor = "#0a150a";
          brickColor = "#1a351a";
        }

        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, 640, 480);

        ctx.fillStyle = brickColor;
        const brickW = 40;
        const brickH = 20;

        for (let row = 0; row < 24; row++) {
          const offset = (row % 2) * (brickW / 2);
          for (let col = -1; col < 17; col++) {
            ctx.fillRect(
              col * brickW + offset + 2,
              row * brickH + 2,
              brickW - 4,
              brickH - 4
            );
          }
        }
      }

      function drawTV(ctx, x, y) {
        ctx.fillStyle = "#111";
        ctx.fillRect(x, y, 60, 50);
        ctx.fillStyle = "#444";
        ctx.fillRect(x + 2, y + 2, 56, 46);
        ctx.fillStyle = "#000";
        ctx.fillRect(x + 4, y + 4, 44, 42);
        ctx.fillStyle = "#222";
        ctx.fillRect(x + 50, y + 8, 6, 6);
        ctx.fillRect(x + 50, y + 18, 6, 6);
        for (let i = 0; i < 50; i++) {
          const nx = x + 4 + Math.random() * 44;
          const ny = y + 4 + Math.random() * 42;
          const shade = Math.random() * 255;
          ctx.fillStyle = `rgba(${shade},${shade},${shade}, 0.8)`;
          ctx.fillRect(nx, ny, 2, 2);
        }
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        ctx.beginPath();
        ctx.moveTo(x + 4, y + 4);
        ctx.lineTo(x + 20, y + 4);
        ctx.lineTo(x + 4, y + 20);
        ctx.fill();
      }

      function spawnScore(x, y, text) {
        scoreFloaters.push({ x, y, text, life: 60 });
      }

      function playSound(type) {
        if (isAttractMode || audioCtx.state === "suspended") {
          if (!isAttractMode) audioCtx.resume();
          if (isAttractMode) return;
        }
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        if (type === "throw") {
          osc.type = "square";
          osc.frequency.setValueAtTime(400, audioCtx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(
            100,
            audioCtx.currentTime + 0.1
          );
          gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === "hit") {
          osc.type = "sawtooth";
          const pitch = 200 + comboCount * 50;
          osc.frequency.setValueAtTime(pitch, audioCtx.currentTime);
          osc.frequency.linearRampToValueAtTime(
            pitch + 400,
            audioCtx.currentTime + 0.1
          );
          gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === "crash") {
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(100, audioCtx.currentTime);
          osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.3);
          gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === "levelup") {
          osc.type = "square";
          osc.frequency.setValueAtTime(400, audioCtx.currentTime);
          osc.frequency.setValueAtTime(500, audioCtx.currentTime + 0.1);
          osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.2);
          osc.frequency.setValueAtTime(800, audioCtx.currentTime + 0.4);
          gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.8);
        }
      }

      function shakeScreen() {
        if (isAttractMode) return;
        displayArea.classList.add("shake");
        setTimeout(() => {
          displayArea.classList.remove("shake");
        }, 500);
      }

      function spawnCustomer() {
        const lane = Math.floor(Math.random() * LANES);
        const customersInLane = customers.filter((c) => c.lane === lane).length;
        if (customersInLane > 2) return;
        const colors = ["#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6"];
        customers.push({
          lane: lane,
          x: 20,
          speed: (0.5 + Math.random() * 0.5) * difficultyMultiplier,
          color: colors[Math.floor(Math.random() * colors.length)],
          pushedBack: 0,
        });
      }

      function createExplosion(x, y) {
        for (let i = 0; i < 5; i++) {
          // Enhanced colorful particles for fever
          let pColor = "#fff";
          if (feverMode) {
            const colors = ["#0ff", "#f0f", "#ff0", "#fff"];
            pColor = colors[Math.floor(Math.random() * colors.length)];
          }
          particles.push({
            x: x,
            y: y - 25,
            vx: (Math.random() - 0.5) * 4,
            vy: (Math.random() - 0.5) * 4,
            life: 20,
            color: pColor,
          });
        }
      }

      function startLevelTransition(newLevel) {
        level = newLevel;
        isLevelTransition = true;
        transitionTimer = 180;
        playSound("levelup");
        customers = [];
        tapes = [];
        player.lane = 1;
        player.visualLane = 1;
        updateUI();
      }

      function checkGameOver() {
        if (lives <= 0) {
          isGameOver = true;
          lives = 0;
          if (score > highScore) {
            highScore = score;
            localStorage.setItem("vhs_highscore", highScore);
          }

          // Get rank
          const rank = calculateRank(score);
          rankDisplayEl.innerText = "RANK: " + rank;

          updateUI();
          finalScoreEl.innerText = "SLUTPOÄNG: " + score;
          gameOverScreen.style.display = "flex";
          playSound("crash");
          if (gameOverTimeout) clearTimeout(gameOverTimeout);
          gameOverTimeout = setTimeout(goToTitle, 15000);
        }
      }

      function updateUI() {
        scoreEl.innerText = "POÄNG: " + score;
        levelEl.innerText = "NIVÅ: " + level;
        highScoreEl.innerText = "HI: " + highScore;
        let heartStr = "";
        for (let i = 0; i < lives; i++) heartStr += " [VHS]";
        livesEl.innerText = "LIV:" + heartStr;

        // Visual indicator for fever in UI
        if (feverMode) scoreEl.style.color = "#0ff";
        else scoreEl.style.color = "#fff";
      }

      function update() {
        if (!isGameRunning && !isAttractMode) return;
        if (isGameOver) return;

        if (isLevelTransition) {
          transitionTimer--;
          if (transitionTimer <= 0) isLevelTransition = false;
          return;
        }

        frameCount++;

        if (isAttractMode) {
          if (aiCooldown > 0) aiCooldown--;
          let targetCustomer = null;
          let maxX = -1;
          customers.forEach((c) => {
            if (c.pushedBack <= 0 && c.x > maxX) {
              maxX = c.x;
              targetCustomer = c;
            }
          });
          if (targetCustomer) {
            if (player.lane < targetCustomer.lane && aiCooldown === 0) {
              player.lane++;
              aiCooldown = 10;
            } else if (player.lane > targetCustomer.lane && aiCooldown === 0) {
              player.lane--;
              aiCooldown = 10;
            } else if (player.lane === targetCustomer.lane) {
              if (Math.random() < 0.1 && player.cooldown === 0) throwTape();
            }
          }
        } else {
          if (level === 1 && score >= LEVEL_THRESHOLDS[0])
            startLevelTransition(2);
          else if (level === 2 && score >= LEVEL_THRESHOLDS[1])
            startLevelTransition(3);
        }

        difficultyMultiplier = baseDifficulty + score / 500;
        let spawnRate = Math.max(40, 180 / baseDifficulty - score / 10);
        if (frameCount % Math.floor(spawnRate) === 0) spawnCustomer();

        // Reset combo if too much time passes
        if (Date.now() - lastHitTime > 2000) {
          comboCount = 0;
          feverMode = false;
          displayArea.classList.remove("fever");
        }

        const speed = 0.2;
        const diff = player.lane - player.visualLane;
        if (Math.abs(diff) > 0.05) {
          player.visualLane += Math.sign(diff) * speed;
          player.isMoving = true;
        } else {
          player.visualLane = player.lane;
          player.isMoving = false;
        }

        if (player.cooldown > 0) player.cooldown--;
        if (player.throwAnim > 0) player.throwAnim--;

        for (let i = tapes.length - 1; i >= 0; i--) {
          let t = tapes[i];
          t.x -= 6;
          if (t.x < 10) {
            tapes.splice(i, 1);
            if (!isAttractMode) {
              // --- FIX: Only lose life if NOT in turbo mode ---
              if (rapidFireTimer <= 0) {
                lives--;
                comboCount = 0; // Reset on miss
                feverMode = false;
                displayArea.classList.remove("fever");
                shakeScreen();
                playSound("crash");
                checkGameOver();
              }
              // --- END FIX ---
            }
            createExplosion(20, LANE_START_Y + t.lane * LANE_HEIGHT + 40);
          }
        }

        // Update Powerups Movement
        for (let i = powerups.length - 1; i >= 0; i--) {
          let p = powerups[i];
          p.x += 1; // Move slowly to right
          // If reach right side (counter), just disappear
          if (p.x > 500) {
            powerups.splice(i, 1);
          }
        }

        for (let i = customers.length - 1; i >= 0; i--) {
          let c = customers[i];
          if (c.pushedBack > 0) {
            c.x -= 6;
            c.pushedBack -= 6;
            if (c.x < -20) {
              customers.splice(i, 1);
              score += 50;
              spawnScore(20, LANE_START_Y + c.lane * LANE_HEIGHT + 20, "50");
              continue;
            }
          } else {
            c.x += c.speed;
          }
          if (c.x > TAP_X - 20) {
            if (isAttractMode) {
              isGameOver = true;
              goToTitle();
            } else {
              lives = 0;
              shakeScreen();
              checkGameOver();
            }
          }
        }

        tapes.forEach((t) => {
          // Collision with Customers
          customers.forEach((c) => {
            if (t.lane === c.lane && !t.dead) {
              if (t.x < c.x + 20 && t.x > c.x - 10) {
                if (c.pushedBack > 0) {
                  t.dead = true;
                  playSound("hit");
                  createExplosion(
                    c.x,
                    LANE_START_Y + c.lane * LANE_HEIGHT + 40
                  );
                } else {
                  playSound("hit");
                  t.dead = true;
                  c.pushedBack = c.x + 100;
                  comboCount++;
                  lastHitTime = Date.now();

                  // Score logic
                  let points = 10;
                  // Combo bonus
                  let comboBonus = comboCount > 1 ? comboCount * 10 : 0;
                  points += comboBonus;
                  // Fever multiplier
                  if (feverMode) points *= 2;

                  score += points;
                  let scoreText = points.toString();
                  if (feverMode) scoreText += " FEVER!";
                  else if (comboBonus > 0) scoreText += " COMBO!";

                  spawnScore(
                    c.x,
                    LANE_START_Y + c.lane * LANE_HEIGHT,
                    scoreText
                  );
                  createExplosion(
                    c.x,
                    LANE_START_Y + c.lane * LANE_HEIGHT + 40
                  );
                }
              }
            }
          });

          // Collision with Powerups
          powerups.forEach((p, pIndex) => {
            if (t.lane === p.lane && !t.dead && !p.dead) {
              if (t.x < p.x + 20 && t.x > p.x - 10) {
                t.dead = true;
                p.dead = true;
                // Activate Effect!
                if (p.type === "rewind") activateRewind();
                else if (p.type === "rapid") activateRapidFire();

                createExplosion(p.x, LANE_START_Y + p.lane * LANE_HEIGHT + 40);
                powerups.splice(pIndex, 1);
              }
            }
          });
        });

        tapes = tapes.filter((t) => !t.dead);
        for (let i = particles.length - 1; i >= 0; i--) {
          let p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.life--;
          if (p.life <= 0) particles.splice(i, 1);
        }
        for (let i = scoreFloaters.length - 1; i >= 0; i--) {
          let sf = scoreFloaters[i];
          sf.y -= 1;
          sf.life--;
          if (sf.life <= 0) scoreFloaters.splice(i, 1);
        }
        updateUI();
      }

      function draw() {
        drawBrickWall(ctx);

        // Bestäm färger baserat på nivå
        let floorColor1, floorColor2, counterTop, counterSide;

        if (level === 1) {
          // Level 1: Classic Video Store
          floorColor1 = "#2c3e50";
          floorColor2 = "#34495e";
          counterTop = "#9b59b6";
          counterSide = "#8e44ad";
        } else if (level === 2) {
          // Level 2: Future/Cyber Store
          floorColor1 = "#222222"; // Mörkgrå
          floorColor2 = "#333333"; // Ljusare grå
          counterTop = "#00ffff"; // Neon Cyan
          counterSide = "#008888"; // Mörkare Cyan
        } else {
          // Level 3: Toxic Store
          floorColor1 = "#0d2b0d"; // Mörkgrön
          floorColor2 = "#1a351a"; // Ljusare grön
          counterTop = "#ccff00"; // Giftgul
          counterSide = "#88aa00"; // Mörkare gul/grön
        }

        // Rita golv med nivå-färger
        for (let r = 0; r < 8; r++) {
          for (let c = 0; c < 10; c++) {
            ctx.fillStyle = (r + c) % 2 === 0 ? floorColor1 : floorColor2;
            ctx.fillRect(c * 64, r * 60, 64, 60);
          }
        }

        ctx.fillStyle = "#222";
        ctx.fillRect(0, 0, 640, 80);
        ctx.fillStyle = "#ffd700";
        ctx.fillRect(198, 18, 244, 54);
        ctx.fillStyle = "#000";
        ctx.fillRect(200, 20, 240, 50);
        ctx.fillStyle = "#e74c3c";
        ctx.font = '10px "Press Start 2P"';
        ctx.fillText("NETFLIX", 290, 40);
        ctx.fillStyle = "#fff";
        ctx.fillText("COMING SOON...", 270, 55);
        drawTV(ctx, 500, 15);

        for (let i = 0; i < LANES; i++) {
          const y = LANE_START_Y + i * LANE_HEIGHT;
          ctx.fillStyle = "rgba(0,0,0,0.5)";
          ctx.fillRect(0, y - 35, 640, 20);
          drawSprite(ctx, "shelf", 0, y - 35);

          // Rita disk med nivå-färger
          ctx.fillStyle = counterTop;
          ctx.fillRect(0, y, 640, 4);
          ctx.fillStyle = counterSide;
          ctx.fillRect(0, y + 4, 640, 8);

          ctx.fillStyle = "#f39c12";
          ctx.fillRect(TAP_X, y, 12, 40);
          ctx.fillStyle = "#000";
          ctx.fillRect(TAP_X + 2, y + 10, 8, 20);
          ctx.fillStyle = "#444";
          ctx.fillRect(0, y - 50, 25, 60);
          ctx.fillStyle = "#111";
          ctx.fillRect(2, y - 48, 21, 58);
          const blink = Math.floor(Date.now() / 500) % 2 === 0;
          ctx.fillStyle = blink ? "#00ff00" : "#003300";
          ctx.fillRect(2, y - 60, 21, 10);
          ctx.fillStyle = blink ? "#fff" : "#888";
          ctx.font = "8px monospace";
          ctx.fillText("UT", 6, y - 52);
        }

        customers.sort((a, b) => a.lane - b.lane);
        customers.forEach((c) => {
          const y = LANE_START_Y + c.lane * LANE_HEIGHT + 40;
          drawSprite(ctx, "customer", c.x, y, { color: c.color });
        });

        // Draw Powerups
        powerups.forEach((p) => {
          const y = LANE_START_Y + p.lane * LANE_HEIGHT + 40;
          drawSprite(ctx, "powerup", p.x, y, { subType: p.type });
        });

        tapes.forEach((t) => {
          const y = LANE_START_Y + t.lane * LANE_HEIGHT + 40;
          drawSprite(ctx, "tape", t.x, y);
        });
        const playerY = LANE_START_Y + player.visualLane * LANE_HEIGHT + 40;
        drawSprite(ctx, "player", PLAYER_X, playerY, {
          throwing: player.throwAnim,
          isMoving: player.isMoving,
        });
        particles.forEach((p) => {
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, 4, 4);
        });
        scoreFloaters.forEach((sf) => {
          ctx.fillStyle = "#fff";
          ctx.font = '10px "Press Start 2P"';
          ctx.fillText(sf.text, sf.x, sf.y);
        });

        if (isAttractMode) {
          const blink = Math.floor(Date.now() / 800) % 2 === 0;
          if (blink) {
            ctx.fillStyle = "#ffffff";
            ctx.font = '20px "Press Start 2P"';
            ctx.fillText("DEMO PLAY", 240, 240);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.strokeText("DEMO PLAY", 240, 240);
          }
        }

        if (isLevelTransition) {
          const blink = Math.floor(Date.now() / 200) % 2 === 0;
          if (blink) {
            ctx.fillStyle = "#f1c40f";
            ctx.font = '30px "Press Start 2P"';
            ctx.fillText("NIVÅ " + level, 240, 240);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 3;
            ctx.strokeText("NIVÅ " + level, 240, 240);
          }
        }
      }

      function gameLoop() {
        if (!isGameOver) {
          update();
          draw();
          gameLoopId = requestAnimationFrame(gameLoop);
        }
      }

      window.addEventListener("keydown", (e) => {
        if (isAttractMode) {
          interruptAttractMode();
          return;
        }
        if (e.code === "ArrowUp") movePlayer(-1);
        if (e.code === "ArrowDown") movePlayer(1);
        if (e.code === "Space") throwTape();
      });

      document.body.addEventListener("click", (e) => {
        if (isAttractMode && !e.target.closest("#controls"))
          interruptAttractMode();
      });

      // 3. KOPPLA FUNKTIONER TILL WINDOW SIST
      window.selectMenu = selectMenu;
      window.startGame = startGame;
      window.goToTitle = goToTitle;
      window.movePlayer = movePlayer;
      window.throwTape = throwTape;
      window.handleStartButton = handleStartButton;
      window.handleSelectButton = handleSelectButton;

      draw(); // Rita en gång vid start
      startAttractTimer();
    </script>
  </body>
</html>
